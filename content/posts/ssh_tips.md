---
title: "SSH tips"
date: 2024-03-31T20:06:23+03:00
draft: true
slug: ssh_tips
aliases:
  - ssh_tips
weight: 10010
toc_hide: true
tags:
  - linux
---

## Безопасность SSH
Конфигурация сервера SSH находится в файле /etc/ssh/sshd_config. Необходимо изменить некоторые строки. Здесь изменяемые опции представлены в алфавитном порядке.
```
AllowAgentForwarding no
AllowTcpForwarding no
ChallengeResponseAuthentication no
PasswordAuthentication no
PermitRootLogin no
PermitUserEnvironment no
UseDNS no
X11Forwarding no
```

После изменения конфигурации перезапустите сервис:
```
sudo systemctl restart sshd
```
## Смена порта SSH
По умолчанию SSH использует порт 22. Вредоносное ПО и злоумышленники будут подключаться к этому порту вашего сервера в попытках получить доступ. Сделаем эту задачу сложнее и сменим порт, на котором работает SSH. Для начала выберите любой порт с номером от 1025 до 49150. Постарайтесь выбрать порт, который не используется в сети, поскольку эти порты тоже будут уязвимы.

Некоторые поставщики виртуальных серверов могут по умолчанию включать сетевой экран в своей сети и закрывать доступ ко всем портам сервера, кроме 22-го. Перед выполнением дальнейших инструкций в этом разделе убедитесь, что такой сетевой экран выключен в интерфейсе поставщика или отсутствует, либо разрешите в его настройках дополнительный порт.

В файле /etc/ssh/sshd_config отредактируйте строку #Port 22, изменив значение и убрав символ комментария, например: Port 48428. Перезапустите сервис:
```
sudo systemctl restart sshd
```
С этого момента при подключении к серверу необходимо будет указывать порт:
```
ssh -p 48428 username@41.106.121.3
```

## Сетевой экран

Сетевой экран используется для контроля подключений к серверу. С его помощью мы можем определять, с каких адресов к каким портам сервера подключения разрешены. Установим UFW и сразу разрешим доступ к порту сервера SSH, чтобы не запретить доступ себе, затем включим сетевой экран:
```
sudo apt install ufw
sudo ufw default allow outgoing
sudo ufw allow in 48428/tcp # замените на ваш порт SSH
sudo ufw default deny incoming
sudo ufw enable
```
Текущие правила можно посмотреть командой sudo ufw status verbose. По умолчанию UFW пишет информацию о соединениях в журнал. Эту опцию можно отключить командой sudo ufw logging off.

## Fail2Ban
Fail2Ban — ПО для защиты от атак с подбором пароля. После нескольких неудачных попыток авторизации по SSH Fail2Ban заблокирует попытки подключения с подозрительного IP-адреса на некоторое время. Настройка не требуется, достаточно установить:
```
sudo apt install fail2ban
```
Fail2Ban не конфликтует с сетевым экраном UFW. Для выявления подозрительной активности он читает системные журналы. Его можно использовать для выявления атак не только на SSH, но на любой другой сервис.

## Port knocking для входа по SSH

Ещё более надёжным решением можем быть port knocking. Это способ защиты от сканирования портов с целью поиска порта SSH. При использовании port knocking порт SSH по умолчанию закрыт с помощью сетевого экрана и открывается только на короткое время после получения правильной последовательности сетевых пакетов. Установим knockd на сервер и на локальное устройство:
```
sudo apt install knockd
```
Замените содержимое файла /etc/knockd.conf на сервере на следующие настройки, но вместо портов 2222, 3333, 4444 укажите другие номера, не следующие друг за другом в порядке возрастания или убывания, а вместо порта 48428 укажите порт, используемый для SSH.
```
[options]
    UseSyslog

[opencloseSSH]
    sequence      = 2222:udp,3333:udp,4444:udp
    seq_timeout   = 15
    tcpflags      = syn,ack
    start_command = ufw allow from %IP% to any port 48428
    cmd_timeout   = 5
    stop_command  = ufw delete allow from %IP% to any port 48428
```
Включите сервис и удалите правила, разрешающие подключения к порту SSH с любого IP-адреса:
```
sudo systemctl enable --now knockd
sudo ufw delete allow 48428/tcp
```
Отключитесь от сервера. Следующее подключение будет возможно после отправки правильной последовательности пакетов:
```
knock 46.101.128.1 2222:udp 3333:udp 4444:udp
ssh -p 48428 username@41.106.121.3
```
## Ограничение размера журналов
При высокой активности сервера или при наличии ошибок системные журналы могут занимать много места на диске. Чтобы избежать ситуации, при которой свободное место закончится и сервер станет недоступен, можно ограничить максимальный размер журналов. Внесите изменения в файл /etc/systemd/journald.conf: удалите символ комментария в строке #SystemMaxUse= и установите значение, например: SystemMaxUse=50M.
Для немедленной очистки журналов (например, старше 1 дня) используйте следующие команды:
```
sudo journalctl --rotate
sudo journalctl --vacuum-time=1d
```




