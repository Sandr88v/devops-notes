---
title: "Ansible vault как средство хранения секретов"
date: 2024-03-16T21:46:02+03:00
slug: ansible_vault
aliases:
  - ansible_vault
weight: 10010
toc_hide: true
tags:
  - ansible
  - trips
---

## Ansible vault как инструмент

Ansible vault — инструмент, позволяющий зашифровать и расшифровать файлы переменных. Для шифрования используется парольная фраза. Соответственно, чем сложнее фраза, тем сложнее злоумышленнику расшифровать данные. В основном используется два метода использования парольной фразы:
- создать файл, записать в него парольную фразу и использовать этот файл при попытке шифрования yml файлов. В этом случае в строку вызова добавляется параметр —vault-password-file=<путь к файлу>
- вводить парольную фразу с клавиатуры при каждом обращении к инструменту ansible-vault. В строку вызова добавляется ключ —ask-vault-pass

## Создание и редактирование секретов

Создание зашифрованного файла средствами ansible-vault:

```
# с помощью файла с парольной фразой
ansible-vault create test_secret_file_1.yml --vault-password-file=/u01/ansible/secret
# ввод парольной фразы с клавиатуры
ansible-vault create test_secret_file_2.yml
New Vault password:
Confirm New Vault password:
```
Для того, чтобы отредактировать файл, необходимо указать директиву edit:

```
# с помощью файла с парольной фразой
ansible-vault edit test_secret_file_1.yml --vault-password-file=/u01/ansible/secret
# ввод парольной фразы с клавиатуры
ansible-vault edit test_secret_file_2.yml
Vault password:
```
## Шифрование и дешифрование

Ansible поставляется с утилитой командной строки ansible-vault, которая позволяет создавать и управлять шифрованными файлами. Таким образом, вы можете «коммитить» зашифрованный файл в вашу систему управления версиями и только пользователи с паролем дешифрования смогут прочесть его.

Прежде чем начать, установите редактор по умолчанию для Ansible Vault.

```
--- Для Bash---
$ echo "export EDITOR=vim" >> ~/.bashrc
$ source ~/.bashrc

--- Для Zsh ---
$ echo "export EDITOR=vim" >> ~/.zshrc
$ source ~/.zshrc
```
Замените vim вашим любимым редактором.

```
# Зашифровать существующий файл. Вам необходимо создать пароль шифрования.
ansible-vault encrypt secrets.yml

# Создать новый зашифрованный файл. Вам необходимо создать пароль шифрования.
ansible-vault create secrets.yml

# Расшифровать файл. Вам необходимо ввести пароль, используемый для шифрования.
# Используйте с осторожностью! Не оставляйте ваши файлы не зашифрованными.
ansible-vault decrypt secrets.yml

# Редактировать зашифрованный файл
# (по-умолчанию используется vim, переопределяется переменной окружения $EDITOR)
ansible-vault edit secrets.yml

# Отобразить содержимое зашифрованного файла
ansible-vault edit secrets.yml
```
## Установите переменную среды

ANSIBLE_VAULT_PASSWORD_FILE

Если вам не нравится указывать флаг пароля или использовать интерактивный запрос пароля, вы можете настроить Ansible на автоматическое чтение файла пароля.

Это достигается путем установки переменной среды ANSIBLE_VAULT_PASSWORD_FILE с путем к файлу пароля:

```
export ANSIBLE_VAULT_PASSWORD_FILE=./.ansible_vault_pass
```

Чтобы сохранить конфигурацию, установите ее в локальном файле ansible.cfg.

```
vim ansible.cfg

[defaults]
........
vault_password_file = ./.ansible_vault_pass
```
Ansible будет использовать пароль конфигурации для всех операций шифрования и создания.




